/**
 * BSD 3-Clause License
 *
 * Copyright Â© 2019, viadee Unternehmensberatung AG
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 *
 * * Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
package scanhelper.views;

import com.vaadin.flow.component.ComponentEventListener;
import com.vaadin.flow.component.button.Button;
import com.vaadin.flow.component.dialog.Dialog;
import com.vaadin.flow.component.dialog.GeneratedVaadinDialog;
import com.vaadin.flow.component.grid.Grid;
import com.vaadin.flow.component.grid.Grid.Column;
import com.vaadin.flow.component.grid.editor.Editor;
import com.vaadin.flow.component.html.Div;
import com.vaadin.flow.component.icon.Icon;
import com.vaadin.flow.component.icon.VaadinIcon;
import com.vaadin.flow.component.orderedlayout.HorizontalLayout;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.component.textfield.TextField;
import com.vaadin.flow.data.binder.Binder;
import com.vaadin.flow.router.Route;
import com.vaadin.flow.router.RouterLayout;
import scanhelper.entities.NativeHtmlMapping;
import scanhelper.presenter.HtmlElementsPresenter;
import org.springframework.beans.factory.annotation.Autowired;

/**
 * View that shows the HTML mappings and allows editing them.
 */
@Route(value = "htmlelements", layout = MainView.class)
public class HtmlElementsView extends VerticalLayout implements RouterLayout, ComponentEventListener<GeneratedVaadinDialog.OpenedChangeEvent<Dialog>> {
    private Grid<NativeHtmlMapping> grid = new Grid<>();
    private HtmlElementsPresenter presenter;

    public HtmlElementsView(@Autowired HtmlElementsPresenter presenter, @Autowired AddElementDialog dialog) {
        this.presenter = presenter;
        dialog.addOpenedChangeListener(this);

        // Create action buttons.
        HorizontalLayout actionbar = new HorizontalLayout();
        Button addElement = new Button("Add", new Icon(VaadinIcon.PLUS), e -> {
            dialog.open();
        });
        Button btnDelete = new Button(new Icon(VaadinIcon.TRASH), e -> {
            presenter.deleteHtmlMappings(grid.getSelectedItems());
            grid.setItems(presenter.getAllNativeHtmlMappings());
        });
        actionbar.add(addElement, btnDelete);

        // Create list of elements.
        grid.setItems(presenter.getAllNativeHtmlMappings());
        grid.addColumn(NativeHtmlMapping::getId).setHeader("ID");
        Column<NativeHtmlMapping> htmltagColumn = grid.addColumn(NativeHtmlMapping::getHtmltag).setHeader("HTML Tag");
        Column<NativeHtmlMapping> nativehtmlColumn = grid.addColumn(NativeHtmlMapping::getNativeHtml).setHeader("Native HTML Element");
        Column<NativeHtmlMapping> defaultvalColumn = grid.addColumn(NativeHtmlMapping::getDefaultValue).setHeader("Default value");
        grid.setSelectionMode(Grid.SelectionMode.MULTI);

        // Create input elements for editing mode.
        TextField tfHtmltag = new TextField();
        TextField tfNativehtml = new TextField();
        TextField tfDefaultVal = new TextField();

        // Add editor.
        Binder<NativeHtmlMapping> binder = new Binder<>(NativeHtmlMapping.class);
        Editor<NativeHtmlMapping> editor = grid.getEditor();
        editor.setBinder(binder);
        editor.setBuffered(true);

        binder.bind(tfHtmltag, "htmltag");
        htmltagColumn.setEditorComponent(tfHtmltag);
        binder.bind(tfNativehtml, "nativeHtml");
        nativehtmlColumn.setEditorComponent(tfNativehtml);
        binder.bind(tfDefaultVal, "defaultValue");
        defaultvalColumn.setEditorComponent(tfDefaultVal);

        Button btnSave = new Button("Save", e -> editor.save());
        Button btnCancel = new Button("Cancel", e -> editor.cancel());
        Div buttons = new Div(btnSave, btnCancel);

        Column<NativeHtmlMapping> editorColumn = grid.addComponentColumn(element -> {
            Button btnEdit = new Button(new Icon(VaadinIcon.EDIT));
            btnEdit.addClickListener( e -> editor.editItem(element));
            return btnEdit;
        });
        editorColumn.setEditorComponent(buttons);

        editor.addSaveListener(event -> {
            presenter.saveElement(event.getItem());
        });

        this.add(actionbar, grid);
    }

    @Override
    public void onComponentEvent(GeneratedVaadinDialog.OpenedChangeEvent<Dialog> dialogOpenedChangeEvent) {
        // Refresh grid if dialog was closed.
        if (!dialogOpenedChangeEvent.isOpened()) {
            grid.setItems(presenter.getAllNativeHtmlMappings());
        }
    }
}
